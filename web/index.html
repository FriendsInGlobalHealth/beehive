<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beehive</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="beehive.css"/>
    <style>
        body { padding-top:20px; }
        .heading {
            text-align: center;
            background: green;
            color: white;
        }

        .scrollable-panel-body {
            min-height: 200px;
            max-height: 1000px;
            overflow-y: scroll;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
    <div class="row">
    <div class="col-lg-3" style="position: sticky;">
        <div class="panel panel-success">
            <div class="panel-heading">
                <h4 class="panel-title">Merged Sources</h4>
            </div>
            <div class="panel-body" style="padding:2px;">
                <table class="table table-bordered table-striped" style="margin-bottom:0;">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>Source</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="sources-rows">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-9" style="padding-left:0;">
        <div class="jumbotron">
            <h2>Beehive Merging Application</h2>
        </div>
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="false">
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  Click To Expand/Collapse Instructions
                </a>
              </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                    <h2 id="introduction">Introduction</h2>
                    <p>This nodejs application merges two instances of OpenMRS databases into one. It
                    works by connecting to the two databases and move data from designated source
                    database into designated destination database. Once run successfully, the
                    designated destination database will be a merger of the two initial instances.</p>
                    <p><strong>Note:</strong></p>
                    <ol>
                    <li>If you still want the original copy of the destination database, then
                    you have to create a copy before running this application on it.</li>
                    <li>The assumption is made that the two OpenMRS instances share the same
                     metadata (i.e. concepts, forms e.t.c).</li>
                    <li>For the purpose of this implementation, some of the tables are purposely ignored
                    (See below for the list of tables included)</li>
                    </ol>
                    <h2 id="tables">Tables</h2>
                    <p>Below is the list of tables whose records are moved.</p>
                    <ol>
                    <li><p><em>person</em></p>
                    </li>
                    <li><p><em>person_attribute_type</em></p>
                    </li>
                    <li><p><em>person_attribute</em></p>
                    </li>
                    <li><p><em>person_name</em></p>
                    </li>
                    <li><p><em>person_address</em></p>
                    </li>
                    <li><p><em>relationship_type</em></p>
                    </li>
                    <li><p><em>relationship</em></p>
                    </li>
                    <li><p><em>patient</em></p>
                    </li>
                    <li><p><em>patient_identifier_type</em></p>
                    </li>
                    <li><p><em>patient_identifier</em></p>
                    </li>
                    <li><p><em>users</em></p>
                    </li>
                    <li><p><em>role</em></p>
                    </li>
                    <li><p><em>role_role</em></p>
                    </li>
                    <li><p><em>privilege</em></p>
                    </li>
                    <li><p><em>role_privilege</em></p>
                    </li>
                    <li><p><em>user_role</em></p>
                    </li>
                    <li><p><em>location</em></p>
                    </li>
                    <li><p><em>provider</em></p>
                    </li>
                    <li><p><em>provider_attribute_type</em></p>
                    </li>
                    <li><p><em>provider_attribute</em></p>
                    </li>
                    <li><p><em>visit</em></p>
                    </li>
                    <li><p><em>visit_type</em></p>
                    </li>
                    <li><p><em>encounter</em></p>
                    </li>
                    <li><p><em>encounter_role</em></p>
                    </li>
                    <li><p><em>encounter_provider</em></p>
                    </li>
                    <li><p><em>obs</em></p>
                    </li>
                    <li><p><em>program</em></p>
                    </li>
                    <li><p><em>program_workflow</em></p>
                    </li>
                    <li><p><em>program_workflow_state</em></p>
                    </li>
                    <li><p><em>patient_state</em></p>
                    </li>
                    <li><p><em>GAAC module tables</em></p>
                    </li>
                    </ol>
                    <h2 id="requirements">Requirements</h2>
                    <ul>
                    <li>nodejs 7+</li>
                    </ul>
                    <h2 id="running">Running</h2>
                    <p>Clone the code from github.</p>
                    <p><code>$ git clone https://github.com/mhawila/beehive.git</code></p>
                    <p>Switch to branch multi-transcation</p>
                    <p><code>$ git checkout multi-transaction</code></p>
                    <p>Change into the project directory, and create a JSON configuration file called
                    <em>config.json</em> putting the following content.</p>
                    <pre><code class="lang-javascript">{
                        <span class="hljs-string">"source"</span>: {
                            <span class="hljs-string">"host"</span>: <span class="hljs-string">"mysql source host or IP"</span>,
                            <span class="hljs-string">"username"</span>: <span class="hljs-string">"username"</span>,
                            <span class="hljs-string">"password"</span>: <span class="hljs-string">"secret"</span>,
                            <span class="hljs-string">"openmrsDb"</span>: <span class="hljs-string">"openmrs1"</span>,
                            <span class="hljs-string">"location"</span>: <span class="hljs-string">"unique string to identify location"</span>    //Must be provided.
                        },
                        <span class="hljs-string">"destination"</span>: {
                            <span class="hljs-string">"host"</span>: <span class="hljs-string">"mysql destination host or IP"</span>,
                            <span class="hljs-string">"username"</span>: <span class="hljs-string">"username"</span>,
                            <span class="hljs-string">"password"</span>: <span class="hljs-string">"secret"</span>,
                            <span class="hljs-string">"openmrsDb"</span>: <span class="hljs-string">"openmrs2"</span>
                        },
                        <span class="hljs-string">"batchSize"</span>: <span class="hljs-number">16000</span>,
                        <span class="hljs-string">"generateNewUuids"</span>: <span class="hljs-literal">true</span>,       //Must be provided.
                        <span class="hljs-string">"debug"</span>: <span class="hljs-literal">false</span>
                    }
                    </code></pre>
                    <h3 id="explanation-of-configuration-options">Explanation of configuration options</h3>
                    <ul>
                    <li><em>batchSize</em>: This is number of records that will be moved at a time.</li>
                    <li><em>generateNewUuids</em>: Whether to generate UUIDs or not. If you want to move the records with existing UUID which is recommended set this to false
                             <em>**note:**</em> This option has to be explicitly provided.
                    </li>
                    <li><em>debug</em>: Whether to print debug level statements.</li>
                    </ul>
                    <p><strong>Note:</strong> Substitute the given values with appropriate values.</p>
                    <p>Once the configuration file is in place, Install the required dependencies:</p>
                    <pre><code class="lang-shell">$ npm <span class="hljs-keyword">install</span>
                    </code></pre>
                    <p>Run the application</p>
                    <em>You don't need to run these commands if you are using this web UI (Simply use the buttons provided below)</em>
                    <pre><code class="lang-shell">$ <span class="hljs-keyword">node</span> <span class="hljs-title">--harmony</span> orchestrator.js
                    </code></pre>
                    <p>Running without committing changes to the database (Dry running)</p>
                    <pre><code class="lang-shell">$ <span class="hljs-keyword">node</span> <span class="hljs-title">--harmony</span> orchestrator.js --dry-run
                    </code></pre>
                    <h3 id="memory-issues-">Memory Issues.</h3>
                    <p>This application can be very memory intensive because it reads large sections of tables into memory.
                    As a result because the default memory limit in Node.js is 512 MB, sometimes the user might experience the
                    <code>Javascript heap out of memory</code> error when merging big databases.</p>
                    <p>V8 which Node.js is based provided an option <code>--max_old_space_size=Y</code> where <code>Y</code> is the number interpreted as
                    megabytes. You can use this option to specify more memory. The example below shows node run with max 2GB of
                    memory allocated to it.</p>
                    <pre><code class="lang-shell">$ <span class="hljs-keyword">node</span> <span class="hljs-title">--harmony</span> --<span class="hljs-attr">max_old_space_size=</span><span class="hljs-number">2048</span> orchestrator.js
                    </code></pre>
                    <h2 id="multi-transaction-approach-purely-academic-">Multi Transaction Approach (Purely Academic)</h2>
                    <p><strong>Note:</strong> <em>The user of this application does <strong>NOT</strong> need to understand this section in order to use it.</em></p>
                    <p>Implemented to allow the application to start where it left off in case of an error. This comes handy when
                    moving huge obs tables (to the tune of 5+ million records).</p>
                    <p>Three tables are created in the destination database to facilitate this. The tables and their purposes are as
                    shown below.</p>
                    <ol>
                    <li><em>beehive_merge_progress</em>: This keeps track of the atomic step reached for a particular <em>source</em> being merged to destination.</li>
                    <li><em>beehive_merge<em>idmap</em></em>{source}: There will be one for each source to simplify handling and deleting if necessary. E.g. for a source named <em>namaccura</em> a table named _beehive_merge_idmap<em>namaccura</em> will be added.</li>
                    </ol>
                    <p>There are three atomic steps namely <em><em>pre-obs</em></em>, <em><em>obs</em></em>, and <em><em>post-obs</em></em>. The steps are performed in that order with both pre-obs and post-obs done in one transaction each. The obs step on the other hand can be done in one or multiple transaction depending on the size of the obs table. For a source with an obs table with records equal to or more than a particular number (default is 500,000) more than one transaction is used with each used to move a predefined number of records (default being 250,000).</p>
                    <p>The <em>beehive_merge_progress</em> table in case of a multi-transaction obs step is used also to keep track of the number of obs moved within each transaction. That way, the application can figure out where to start in case there is a need to re-run the application after encountering an error.</p>

              </div>
            </div>
          </div>
        </div>
        <span id="no-configuration" style="display:none; text-color:red">No Configuration Yet</span>

        <div id="configuration-save-success" class="alert alert-success alert-dismissable" style="display:none;">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
            <strong>Configuration Updated successfully!</strong>
        </div>

        <div id="configuration-save-error" class="alert alert-danger alert-dismissable" style="display:none;">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
            <strong>Oops.. Sorry something went wrong!</strong>
        </div>

        <form id="configuration-form">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
            			<th colspan="3" class="heading">DATABASE CONFIGURATION</th>
            		</tr>
            		<tr>
            			<th>&nbsp;</th>
            			<th>Source Database</th>
            			<th>Destination Database</th>
            		</tr>
                </thead>
            	<tbody>
            		<tr>
            			<th>Host</th>
            			<td><input type="text" class="configuration-form" id="source-host" name="source_host" disabled/></td>
            			<td><input type="text" class="configuration-form" id="destination-host" name="destination_host" disabled/></td>
            		</tr>
            		<tr>
            			<th>Username</th>
            			<td><input type="text" class="configuration-form" id="source-username" name="source_username" disabled/></td>
            			<td><input type="text" class="configuration-form" id="destination-username" name="destination_username" disabled/></td>
            		</tr>
            		<tr>
            			<th>Password</th>
            			<td><input type="text" class="configuration-form" id="source-password" name="source_password" disabled/></td>
            			<td><input type="text" class="configuration-form" id="destination-password" name="destination_password" disabled/></td>
            		</tr>
            		<tr>
            			<th>Openmrs DB name</th>
            			<td><input type="text" class="configuration-form" id="source-openmrs-db" name="source_openmrs_db" disabled/></td>
            			<td><input type="text" class="configuration-form" id="destination-openmrs-db" name="destination_openmrs_db" disabled/></td>
            		</tr>
            		<tr>
            			<th colspan="3" class="heading">OTHER CONFIGURATIONS</th>
            		</tr>
                    <tr>
                        <th>Source Location</th>
                        <td colspan="2"><input type="text" class="configuration-form" id="source-location" name="source_location" disabled/></td>
                    </tr>
            		<tr>
            			<th>Batch Size</th>
            			<td colspan="2"><input type="number" class="configuration-form" id="batch-size" name="batch_size" disabled/></td>
            		</tr>
            		<tr>
            			<th>Generate New UUIDs</th>
            			<td colspan="2"><input type="checkbox" class="configuration-form" id="generate-new-uuid" name="generate_new_uuid" disabled/></td>
            		</tr>
            		<tr>
            			<th>Debug</th>
            			<td colspan="2"><input type="checkbox" class="configuration-form" id="debug" name="debug" disabled/></td>
            		</tr>
            		<tr>
            			<th>Persist</th>
            			<td colspan="2"><input type="checkbox" class="configuration-form" id="persist" name="persist" disabled/></td>
            		</tr>
            	</tbody>
            </table>
            <input type="button" class="btn btn-primary outline" id="configuration-button" value="Edit Configuration"/>
            <input type="button" class="btn btn-primary outline" id="dry-run-button" value="Merge - Dry run"/>
            <input type="button" class="btn btn-danger outline" id="run-button" value="Merge"/>
        </form>
        <div class="panel panel-success" style="display:none;margin-top:10px" id="merge-logs-panel">
            <div class="panel-heading">
                <h4 class="panel-title">Merge logs...</h4>
            </div>
            <div class="panel-body scrollable-panel-body" id="socket" style="background:black;">
            </div>
        </div>
    </div>
    </div>
    </div><!-- end of the main container -->
</body>
<script
      src="https://code.jquery.com/jquery-3.4.1.js"
      integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
      crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
    var MERGE_WEB_SOCKET = null;
    function getBasePath() {
        return window.location.protocol + "//" + window.location.host + "/"
    }

    function createConfigurationObject() {
        var configuration = {
            "source": {
                "host": $('#source-host').val(),
                "username": $('#source-username').val(),
                "password": $('#source-password').val(),
                "openmrsDb": $('#source-openmrs-db').val(),
                "location": $('#source-location').val()
            },
            "destination": {
                "host": $('#destination-host').val(),
                "username": $('#destination-username').val(),
                "password": $('#destination-password').val(),
                "openmrsDb": $('#destination-openmrs-db').val()
            },
            "batchSize": $('#batch-size').val(),
            "generateNewUuids": true,
            "debug": true,
            "persist": true
        };

        if($('#generate-new-uuid').prop('checked')) {
            configuration["generateNewUuids"] = true;
        } else {
            configuration["generateNewUuids"] = false;
        }

        if($('#debug').prop('checked')) {
            configuration["debug"] = true;
        } else {
            configuration["debug"] = false;
        }

        if($('#persist').prop('checked')) {
            configuration["persist"] = true
        } else {
            configuration["persist"] = false
        }

        return configuration;
    }

    $(document).ready(function() {
        $('#collapseOne').collapse("hide");

        $.getJSON('configuration', function(data) {
            if(typeof data === 'object') {
                $('#source-host').val(data.source.host)
                $('#source-username').val(data.source.username)
                $('#source-password').val(data.source.password)
                $('#source-openmrs-db').val(data.source.openmrsDb)

                $('#destination-host').val(data.destination.host)
                $('#destination-username').val(data.destination.username)
                $('#destination-password').val(data.destination.password)
                $('#destination-openmrs-db').val(data.destination.openmrsDb)

                $('#source-location').val(data.source.location)
                $('#batch-size').val(data.batchSize)

                if(data.generateNewUuids) {
                    $('#generate-new-uuid').prop('checked', true)
                } else {
                    $('#generate-new-uuid').prop('checked', false)
                }

                if(data.debug) {
                    $('#debug').prop('checked', true)
                } else {
                    $('#debug').prop('checked', false)
                }

                if(data.persist) {
                    $('#persist').prop('checked', true)
                } else {
                    $('#persist').prop('checked', false)
                }
            }
        })

        $.getJSON('sources', function(data) {
            console.log('Received ', data)
            if(Array.isArray(data)) {
                console.log('Here or not?')
                var sourcesRowsBody = $('#sources-rows')
                var sn = 1
                data.forEach(function(source) {
                    var sourceRow = $('<tr>')
                        sourceRow.append('<th>' + sn)
                        sourceRow.append('<td>' + source['source'])
                    if(source['atomic_step'] === 'post-obs' && source['passed'] == 1) {
                        sourceRow.append('<td><span class="label label-success">Completed</span></td>')
                    } else {
                        sourceRow.append('<td><span class="label label-warning">Incomplete</span></td>')
                    }
                    sourcesRowsBody.append(sourceRow)
                    sn++
                })
            }
        })
    })

    $('#configuration-button').click(function() {
        var button = $(this);
        if(button.val() === 'Edit Configuration') {
            $('.configuration-form').removeAttr('disabled')
            button.removeClass('btn-default')
            button.addClass('btn-primary')
            button.val('Save Changes')
        } else {
            // Saving new stuff.
            createConfigurationObject()
            $.post({
                url: 'configuration',
                data: JSON.stringify(createConfigurationObject()),
                dataType: 'json',
                contentType: 'application/json',
                success: function(data) {
                    $('.configuration-form').attr('disabled', true)
                    button.removeClass('btn-primary')
                    button.addClass('btn-default')
                    button.val('Edit Configuration')
                    $('#configuration-save-success').css('display', '')
                },
                error: function(error) {
                    $('#configuration-save-error').css('display', '')
                }
            })
        }
    })

    $('#dry-run-button').click(function() {
        var sock = $('#socket')
        // clear logs if any.
        sock.html('')

        var log = function(m) {
            try {
                var data = JSON.parse(m);
                var color = 'color:';
                if(data.category) {
                    switch(data.category) {
                        case 'ERROR': color += 'red;'; break;
                        case 'OK': color += 'green;'; break;
                        case 'DEBUG': color += 'yellow;'; break;
                        default: color += 'white;';
                    }
                }
                var li = $('<li style="' + color + '">').html(data.message);
            } catch(e) {
                var li = $('<li>').html(new Date().toISOString()+ ' ' + m)
            }

            $('#socket').append(li);
        }

        log('Opening socket connection...')
        $('#merge-logs-panel').css('display','')
        if(MERGE_WEB_SOCKET === null) {
            MERGE_WEB_SOCKET = new WebSocket('ws://' + window.location.host + '/running?dryRun=true')
            MERGE_WEB_SOCKET.addEventListener('message', function(message) { log(message.data)})
            MERGE_WEB_SOCKET.addEventListener('open', log.bind(null, "Connection opened"))
            MERGE_WEB_SOCKET.addEventListener('error', log.bind(null, "some error happened"))
        } else {
            // Just send a message to dryRun
            MERGE_WEB_SOCKET.send('dryRun')
        }

    })
</script>
</html>
